---
  AWSTemplateFormatVersion: "2010-09-09"
  Description: >
    "Implements support for triggering the main AutoSpotting Lambda function on
    regional events such as instance launches or imminent spot terminations that
    can only be detected from wthin a given region"
  Parameters:
    AutoSpottingLambdaARN:
      Description: "The ARN of the main AutoSpotting Lambda function"
      Type: "String"
    LambdaRegionalExecutionRoleARN:
      Description: "Execution Role ARN for Regional Lambda"
      Type: "String"
  Resources:
    EventHandler:
      Type: AWS::Lambda::Function
      Properties:
        Description: >
          "Regional Lambda function that invokes the main AutoSpotting Lambda
          function on events such as instance launches or imminent spot instance
          terminations"
        Handler: "index.handler"
        Runtime: "python3.6"
        Timeout: "300"
        Environment:
          Variables:
            AUTOSPOTTING_LAMBDA_ARN:
              Ref: "AutoSpottingLambdaARN"
        Role:
          Ref: "LambdaRegionalExecutionRoleARN"
        Code:
          ZipFile: |
            from boto3 import client
            from json import dumps
            from os import environ
            from sys import exc_info
            from traceback import print_exc

            lambda_arn = (environ['AUTOSPOTTING_LAMBDA_ARN'])

            def parse_region_from_arn(arn):
                return arn.split(':')[3]

            def handler(event, context):
                snsEvent = {
                    'Records': [
                        {
                            'Event': 'aws:sns',
                            'EventSource': '1.0',
                            'EventSubscriptionArn': 'arn:aws:sns:' + event['region'] + ':FakeAccountId:FakeTopic',
                            'Sns': {
                                'Type': 'Notification',
                                'Message': dumps(event),
                            }
                        }
                    ]
                }
                try:
                    svc = client('lambda', region_name=parse_region_from_arn(lambda_arn))
                    response = svc.invoke(
                        FunctionName=lambda_arn,
                        LogType='Tail',
                        Payload=dumps(snsEvent),
                    )
                    print(response)
                except:
                    print_exc()
                    print("Unexpected error:", exc_info()[0])
    SpotTerminationLambdaPermission:
      Type: "AWS::Lambda::Permission"
      Properties:
        Action: "lambda:InvokeFunction"
        FunctionName:
          Ref: "EventHandler"
        Principal: "events.amazonaws.com"
        SourceArn:
          Fn::GetAtt:
            - "SpotTerminationEventRule"
            - "Arn"
    SpotTerminationEventRule:
      Type: "AWS::Events::Rule"
      Properties:
        Description: >
          "This rule is triggered 2 minutes before AWS terminates a spot
          instance"
        EventPattern:
          detail-type:
            - "EC2 Spot Instance Interruption Warning"
          source:
            - "aws.ec2"
        State: "ENABLED"
        Targets:
          -
            Id: "SpotTerminationEventGenerator"
            Arn:
              Fn::GetAtt:
                - "EventHandler"
                - "Arn"
    InstancePendingLambdaPermission:
      Type: "AWS::Lambda::Permission"
      Properties:
        Action: "lambda:InvokeFunction"
        FunctionName:
          Ref: "EventHandler"
        Principal: "events.amazonaws.com"
        SourceArn:
          Fn::GetAtt:
            - "InstancePendingEventRule"
            - "Arn"
    InstancePendingEventRule:
      Type: "AWS::Events::Rule"
      Properties:
        Description: >
          "This rule is triggered after EC2 launched a new instance and it just
          entered the pending state"
        EventPattern:
          detail-type:
            - "EC2 Instance State-change Notification"
          source:
            - "aws.ec2"
          detail:
              state:
                - "pending"
        State: "ENABLED"
        Targets:
          -
            Id: "InstancePendingEventGenerator"
            Arn:
              Fn::GetAtt:
                - "EventHandler"
                - "Arn"
